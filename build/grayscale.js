!function(e){var t={};function s(r){if(t[r])return t[r].exports;var n=t[r]={i:r,l:!1,exports:{}};return e[r].call(n.exports,n,n.exports,s),n.l=!0,n.exports}s.m=e,s.c=t,s.d=function(e,t,r){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(s.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)s.d(r,n,function(t){return e[t]}.bind(null,n));return r},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="",s(s.s=2)}([,,function(e,t,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),(async()=>{let e=document.querySelector("#canvas").getContext("2d"),t=new Image,r=new Promise((e,s)=>{t.onload=e,t.onerror=s});t.src="assets/images/test.png",await r;let n=(await Promise.resolve().then(()=>s(3))).default,a=await n.workgroup("./build/assembly/optimized.wasm",6,"\n        await (async (data)=>{\n            return instance.exports[data.name](id, ...data.args);\n        })");console.log("created workers!"),e.drawImage(t,0,0);let o=e.getImageData(0,0,640,480),i=Math.min(o.width*o.height*4,1073741824),l=a.allocate(i),p=a.map(l,i,Uint8Array);p.set(o.data),console.log("allocation of shared memory complete!"),await a.task({name:"main",args:[o.width,o.height,l]}).support(),console.log("compute done!"),o.data.set(p),console.log(`copied back data with ${i} bytes!`),e.putImageData(o,0,0)})()},function(e,t,s){"use strict";s.r(t);let r=(e="")=>`\nlet instance = null, threads = 1, id = 0;\n//let table = new WebAssembly.Table({initial: 1, maximum: 65536, shared: true, element: "anyfunc"});\n\n// thread native dispatcher \nonmessage = async (e)=>{\n    let result = null;\n    \n    if (e.data.type == "init") {\n        threads = e.data.threads, id = e.data.id;\n\n        instance = await WebAssembly.instantiate(e.data.module, { env: {\n            abort: function() { throw Error("abort called"); }, memory: e.data.memory\n        }});\n\n        result = await instance.exports.init(threads);\n    }\n    \n    if (e.data.type == "dispatch") {\n        result = await instance.exports[e.data.name](id, ...e.data.args);\n    }\n    \n    if (e.data.type == "support") {\n        result = ${e}(e.data);\n    }\n\n    postMessage(Object.assign(e.data, {result}));\n}\n`;class n{constructor(){}async initiate(e,t=1,s=""){this.workers=[];let n=new Blob([r(s)],{type:"text/javascript"}),a=URL.createObjectURL(n);for(let e=0;e<t;e++)this.workers.push(new Worker(a));this.reponseIndex=0,this.responses={};let o=this.reponseIndex++;return this.responses[o]=[],this.moduleFetch=(await fetch(e)).arrayBuffer(),this.module=await WebAssembly.compile(await this.moduleFetch),this.memory=new WebAssembly.Memory({initial:1,maximum:65536,shared:!0}),this.instance=await WebAssembly.instantiate(this.module,{env:{memory:this.memory,abort:function(){throw Error("abort called")}}}),this.instance.exports.init(t),this.workers.every(async(e,s)=>{e.responses={},e.onmessage=t=>{e.responses[t.data.response].resolved=t.data};let r={};e.responses[o]=r,this.responses[o][s]=new Promise((e,t)=>{Object.defineProperty(r,"resolved",{set:s=>{s?e(s):t()}})}),e.postMessage({response:o,type:"init",module:this.module,memory:this.memory,threads:t,id:s})}),await Promise.all(this.responses[o]),this}async wait(e){let t=await Promise.all(this.responses[e]);return delete this.responses[e],t}task({name:e="main",args:t=[]}){let s=this.reponseIndex++;return this.responses[s]=[],this.workers.every(async(e,t)=>{let r={};e.responses[s]=r,this.responses[s][t]=new Promise((e,t)=>{Object.defineProperty(r,"resolved",{set:s=>{s?e(s):t()}})})}),new a({name:e,args:t,resp:s,workgroup:this})}allocate(e=4){return this.instance.exports.allocate(e)}free(e){return this.instance.exports.free(e)}map(e,t=0,s=Uint8Array){return t?new s(this.instance.exports.memory.buffer,e,t):new s(this.instance.exports.memory.buffer,e)}}class a{constructor({name:e="main",args:t=[],resp:s=0,workgroup:r}){this.workgroup=r,this.resp=s,this.args=t,this.name=e}async dispatch(){return this.workgroup.workers.every(async(e,t)=>{e.postMessage({type:"dispatch",id:t,response:this.resp,name:this.name,args:this.args})}),this.workgroup.wait(this.resp)}async support(){return this.workgroup.workers.every(async(e,t)=>{e.postMessage({type:"support",id:t,response:this.resp,name:this.name,args:this.args})}),this.workgroup.wait(this.resp)}get id(){return this.resp}}t.default={init:async()=>0,workgroup:async(e,t=1,s="")=>(new n).initiate(e,t,s)}}]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly8vd2VicGFjay9ib290c3RyYXAiLCJ3ZWJwYWNrOi8vLy4vZ3JheXNjYWxlLnRzIiwid2VicGFjazovLy8uLi9idWlsZC9saWIvY29tcHV0ZS5qcyJdLCJuYW1lcyI6WyJpbnN0YWxsZWRNb2R1bGVzIiwiX193ZWJwYWNrX3JlcXVpcmVfXyIsIm1vZHVsZUlkIiwiZXhwb3J0cyIsIm1vZHVsZSIsImkiLCJsIiwibW9kdWxlcyIsImNhbGwiLCJtIiwiYyIsImQiLCJuYW1lIiwiZ2V0dGVyIiwibyIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZW51bWVyYWJsZSIsImdldCIsInIiLCJTeW1ib2wiLCJ0b1N0cmluZ1RhZyIsInZhbHVlIiwidCIsIm1vZGUiLCJfX2VzTW9kdWxlIiwibnMiLCJjcmVhdGUiLCJrZXkiLCJiaW5kIiwibiIsIm9iamVjdCIsInByb3BlcnR5IiwicHJvdG90eXBlIiwiaGFzT3duUHJvcGVydHkiLCJwIiwicyIsImN0eCIsImRvY3VtZW50IiwicXVlcnlTZWxlY3RvciIsImdldENvbnRleHQiLCJpbWFnZSIsIkltYWdlIiwicHJvbWlzZSIsIlByb21pc2UiLCJyZXNvbHZlIiwicmVqZWN0Iiwib25sb2FkIiwib25lcnJvciIsInNyYyIsImNvbXB1dGUiLCJkZWZhdWx0Iiwid29ya2dyb3VwIiwiY29uc29sZSIsImxvZyIsImRyYXdJbWFnZSIsImltYWdlRGF0YSIsImdldEltYWdlRGF0YSIsInNpemUiLCJNYXRoIiwibWluIiwid2lkdGgiLCJoZWlnaHQiLCJidWZmZXIiLCJhbGxvY2F0ZSIsIm1hcCIsIlVpbnQ4QXJyYXkiLCJzZXQiLCJkYXRhIiwidGFzayIsImFyZ3MiLCJzdXBwb3J0IiwicHV0SW1hZ2VEYXRhIiwiVGhyZWFkQ29kZSIsIldvcmtncm91cCIsInRocmVhZHMiLCJzdXBwb3J0Q29kZSIsInRoaXMiLCJ3b3JrZXJzIiwiYmxvYiIsIkJsb2IiLCJ0eXBlIiwidXJsIiwiVVJMIiwiY3JlYXRlT2JqZWN0VVJMIiwicHVzaCIsIldvcmtlciIsInJlcG9uc2VJbmRleCIsInJlc3BvbnNlcyIsInJlc3AiLCJtb2R1bGVGZXRjaCIsImZldGNoIiwiYXJyYXlCdWZmZXIiLCJXZWJBc3NlbWJseSIsImNvbXBpbGUiLCJtZW1vcnkiLCJNZW1vcnkiLCJpbml0aWFsIiwibWF4aW11bSIsInNoYXJlZCIsImluc3RhbmNlIiwiaW5zdGFudGlhdGUiLCJlbnYiLCJhYm9ydCIsIkVycm9yIiwiaW5pdCIsImV2ZXJ5IiwiYXN5bmMiLCJ3Iiwib25tZXNzYWdlIiwiZSIsInJlc3BvbnNlIiwicmVzb2x2ZWQiLCJwb3N0TWVzc2FnZSIsImlkIiwiYWxsIiwicmVzdWx0IiwiV29ya3Rhc2siLCJwb2ludGVyIiwiZnJlZSIsInB0ciIsInJhbmdlIiwid2FpdCIsImluaXRpYXRlIl0sIm1hcHBpbmdzIjoiYUFDRSxJQUFJQSxFQUFtQixHQUd2QixTQUFTQyxFQUFvQkMsR0FHNUIsR0FBR0YsRUFBaUJFLEdBQ25CLE9BQU9GLEVBQWlCRSxHQUFVQyxRQUduQyxJQUFJQyxFQUFTSixFQUFpQkUsR0FBWSxDQUN6Q0csRUFBR0gsRUFDSEksR0FBRyxFQUNISCxRQUFTLElBVVYsT0FOQUksRUFBUUwsR0FBVU0sS0FBS0osRUFBT0QsUUFBU0MsRUFBUUEsRUFBT0QsUUFBU0YsR0FHL0RHLEVBQU9FLEdBQUksRUFHSkYsRUFBT0QsUUFLZkYsRUFBb0JRLEVBQUlGLEVBR3hCTixFQUFvQlMsRUFBSVYsRUFHeEJDLEVBQW9CVSxFQUFJLFNBQVNSLEVBQVNTLEVBQU1DLEdBQzNDWixFQUFvQmEsRUFBRVgsRUFBU1MsSUFDbENHLE9BQU9DLGVBQWViLEVBQVNTLEVBQU0sQ0FBRUssWUFBWSxFQUFNQyxJQUFLTCxLQUtoRVosRUFBb0JrQixFQUFJLFNBQVNoQixHQUNYLG9CQUFYaUIsUUFBMEJBLE9BQU9DLGFBQzFDTixPQUFPQyxlQUFlYixFQUFTaUIsT0FBT0MsWUFBYSxDQUFFQyxNQUFPLFdBRTdEUCxPQUFPQyxlQUFlYixFQUFTLGFBQWMsQ0FBRW1CLE9BQU8sS0FRdkRyQixFQUFvQnNCLEVBQUksU0FBU0QsRUFBT0UsR0FFdkMsR0FEVSxFQUFQQSxJQUFVRixFQUFRckIsRUFBb0JxQixJQUMvQixFQUFQRSxFQUFVLE9BQU9GLEVBQ3BCLEdBQVcsRUFBUEUsR0FBOEIsaUJBQVZGLEdBQXNCQSxHQUFTQSxFQUFNRyxXQUFZLE9BQU9ILEVBQ2hGLElBQUlJLEVBQUtYLE9BQU9ZLE9BQU8sTUFHdkIsR0FGQTFCLEVBQW9Ca0IsRUFBRU8sR0FDdEJYLE9BQU9DLGVBQWVVLEVBQUksVUFBVyxDQUFFVCxZQUFZLEVBQU1LLE1BQU9BLElBQ3RELEVBQVBFLEdBQTRCLGlCQUFURixFQUFtQixJQUFJLElBQUlNLEtBQU9OLEVBQU9yQixFQUFvQlUsRUFBRWUsRUFBSUUsRUFBSyxTQUFTQSxHQUFPLE9BQU9OLEVBQU1NLElBQVFDLEtBQUssS0FBTUQsSUFDOUksT0FBT0YsR0FJUnpCLEVBQW9CNkIsRUFBSSxTQUFTMUIsR0FDaEMsSUFBSVMsRUFBU1QsR0FBVUEsRUFBT3FCLFdBQzdCLFdBQXdCLE9BQU9yQixFQUFnQixTQUMvQyxXQUE4QixPQUFPQSxHQUV0QyxPQURBSCxFQUFvQlUsRUFBRUUsRUFBUSxJQUFLQSxHQUM1QkEsR0FJUlosRUFBb0JhLEVBQUksU0FBU2lCLEVBQVFDLEdBQVksT0FBT2pCLE9BQU9rQixVQUFVQyxlQUFlMUIsS0FBS3VCLEVBQVFDLElBR3pHL0IsRUFBb0JrQyxFQUFJLEdBSWpCbEMsRUFBb0JBLEVBQW9CbUMsRUFBSSxHLGtGQzlFckQsV0FDSSxJQUNJQyxFQUQ0QkMsU0FBU0MsY0FBYyxXQUN0Q0MsV0FBVyxNQUd4QkMsRUFBUSxJQUFJQyxNQUNaQyxFQUFVLElBQUlDLFFBQVEsQ0FBQ0MsRUFBUUMsS0FDL0JMLEVBQU1NLE9BQU9GLEVBQ2JKLEVBQU1PLFFBQVFGLElBRWxCTCxFQUFNUSxJQUFNLCtCQUNOTixFQUdOLElBQUlPLFNBQWlDLFFBQU4scUJBQWEsS0FBMkJDLFFBR25FQyxRQUFrQkYsRUFBUUUsVUFBVSxrQ0FBbUMsRUFBRyxtSEFJOUVDLFFBQVFDLElBQUksb0JBR1pqQixFQUFJa0IsVUFBVWQsRUFBTSxFQUFFLEdBR3RCLElBQUllLEVBQVluQixFQUFJb0IsYUFBYSxFQUFFLEVBQUUsSUFBSSxLQUNyQ0MsRUFBT0MsS0FBS0MsSUFBSUosRUFBVUssTUFBTUwsRUFBVU0sT0FBTyxFQUFFLFlBR25EQyxFQUFTWCxFQUFVWSxTQUFTTixHQUc1Qk8sRUFBTWIsRUFBVWEsSUFBZ0JGLEVBQU9MLEVBQUtRLFlBQ2hERCxFQUFJRSxJQUFJWCxFQUFVWSxNQUNsQmYsUUFBUUMsSUFBSSwrQ0FHTkYsRUFBVWlCLEtBQUssQ0FBQ3pELEtBQU0sT0FBUTBELEtBQU0sQ0FBQ2QsRUFBVUssTUFBT0wsRUFBVU0sT0FBUUMsS0FBVVEsVUFDeEZsQixRQUFRQyxJQUFJLGlCQUdaRSxFQUFVWSxLQUFLRCxJQUFJRixHQUNuQlosUUFBUUMsSUFBSSx5QkFBeUJJLFlBR3JDckIsRUFBSW1DLGFBQWFoQixFQUFVLEVBQUUsSUEvQ2pDLEksb0NDSEEsSUFBSWlCLEVBQWEsQ0FBQ0YsRUFBVSxLQUFjLCt1QkF1QnZCQSw4RUFPbkIsTUFBTUcsRUFDRixlQUlBLGVBQWV0RSxFQUFRdUUsRUFBVSxFQUFHQyxFQUFjLElBRTlDQyxLQUFLQyxRQUFVLEdBR2YsSUFBSUMsRUFBTyxJQUFJQyxLQUFLLENBQUNQLEVBQVdHLElBQWMsQ0FBQ0ssS0FBSyxvQkFBcUJDLEVBQU1DLElBQUlDLGdCQUFnQkwsR0FDbkcsSUFBSyxJQUFJMUUsRUFBRSxFQUFFQSxFQUFFc0UsRUFBUXRFLElBQU93RSxLQUFLQyxRQUFRTyxLQUFLLElBQUlDLE9BQU9KLElBRzNETCxLQUFLVSxhQUFlLEVBQUdWLEtBQUtXLFVBQVksR0FHeEMsSUFBSUMsRUFBT1osS0FBS1UsZUFpQ2hCLE9BaENBVixLQUFLVyxVQUFVQyxHQUFRLEdBR3ZCWixLQUFLYSxtQkFBcUJDLE1BQU12RixJQUFTd0YsY0FDekNmLEtBQUt6RSxhQUFleUYsWUFBWUMsY0FBY2pCLEtBQUthLGFBR25EYixLQUFLa0IsT0FBUyxJQUFJRixZQUFZRyxPQUFPLENBQUNDLFFBQVMsRUFBR0MsUUFBUyxNQUFPQyxRQUFRLElBSTFFdEIsS0FBS3VCLGVBQWlCUCxZQUFZUSxZQUFZeEIsS0FBS3pFLE9BQVEsQ0FBRWtHLElBQUssQ0FDOURQLE9BQVFsQixLQUFLa0IsT0FDYlEsTUFBTyxXQUFhLE1BQU1DLE1BQU0sb0JBRXBDM0IsS0FBS3VCLFNBQVNqRyxRQUFRc0csS0FBSzlCLEdBRTNCRSxLQUFLQyxRQUFRNEIsTUFBTUMsTUFBT0MsRUFBRXZHLEtBQ3hCdUcsRUFBRXBCLFVBQVksR0FDZG9CLEVBQUVDLFVBQWFDLElBQU1GLEVBQUVwQixVQUFVc0IsRUFBRTFDLEtBQUsyQyxVQUFVQyxTQUFXRixFQUFFMUMsTUFHL0QsSUFBSTJDLEVBQVcsR0FBSUgsRUFBRXBCLFVBQVVDLEdBQVFzQixFQUN2Q2xDLEtBQUtXLFVBQVVDLEdBQU1wRixHQUFLLElBQUl1QyxRQUFRLENBQUNDLEVBQVFDLEtBQVcvQixPQUFPQyxlQUFlK0YsRUFBVSxXQUFZLENBQUM1QyxJQUFLN0MsSUFBV0EsRUFBTXVCLEVBQVF2QixHQUFPd0IsU0FHNUk4RCxFQUFFSyxZQUFZLENBQUVGLFNBQVV0QixFQUFNUixLQUFNLE9BQVE3RSxPQUFReUUsS0FBS3pFLE9BQVEyRixPQUFRbEIsS0FBS2tCLE9BQVFwQixVQUFTdUMsR0FBSTdHLFlBSW5HdUMsUUFBUXVFLElBQUl0QyxLQUFLVyxVQUFVQyxJQUUxQlosS0FJWCxXQUFXWSxHQUNQLElBQUkyQixRQUFleEUsUUFBUXVFLElBQUl0QyxLQUFLVyxVQUFVQyxJQUU5QyxjQURPWixLQUFLVyxVQUFVQyxHQUNmMkIsRUFJWCxNQUFLLEtBQUN4RyxFQUFLLE9BQU0sS0FBQzBELEVBQUssS0FFbkIsSUFBSW1CLEVBQU9aLEtBQUtVLGVBU2hCLE9BUkFWLEtBQUtXLFVBQVVDLEdBQVEsR0FHdkJaLEtBQUtDLFFBQVE0QixNQUFNQyxNQUFPQyxFQUFFdkcsS0FDeEIsSUFBSTBHLEVBQVcsR0FBSUgsRUFBRXBCLFVBQVVDLEdBQVFzQixFQUN2Q2xDLEtBQUtXLFVBQVVDLEdBQU1wRixHQUFLLElBQUl1QyxRQUFRLENBQUNDLEVBQVFDLEtBQVcvQixPQUFPQyxlQUFlK0YsRUFBVSxXQUFZLENBQUM1QyxJQUFLN0MsSUFBV0EsRUFBTXVCLEVBQVF2QixHQUFPd0IsV0FHekksSUFBSXVFLEVBQVMsQ0FBQ3pHLE9BQUswRCxPQUFLbUIsT0FBS3JDLFVBQVV5QixPQUlsRCxTQUFTbkIsRUFBTyxHQUNaLE9BQU9tQixLQUFLdUIsU0FBU2pHLFFBQVE2RCxTQUFTTixHQUkxQyxLQUFLNEQsR0FDRCxPQUFPekMsS0FBS3VCLFNBQVNqRyxRQUFRb0gsS0FBS0QsR0FJdEMsSUFBSUUsRUFBS0MsRUFBUSxFQUFHeEMsRUFBT2YsWUFDdkIsT0FBSXVELEVBQ08sSUFBSXhDLEVBQUtKLEtBQUt1QixTQUFTakcsUUFBUTRGLE9BQU9oQyxPQUFReUQsRUFBS0MsR0FFbkQsSUFBSXhDLEVBQUtKLEtBQUt1QixTQUFTakcsUUFBUTRGLE9BQU9oQyxPQUFReUQsSUFLakUsTUFBTUgsRUFDRixhQUFZLEtBQUN6RyxFQUFLLE9BQU0sS0FBQzBELEVBQUssR0FBRSxLQUFDbUIsRUFBSyxFQUFDLFVBQUNyQyxJQUNwQ3lCLEtBQUt6QixVQUFZQSxFQUFXeUIsS0FBS1ksS0FBT0EsRUFBTVosS0FBS1AsS0FBT0EsRUFBTU8sS0FBS2pFLEtBQU9BLEVBSWhGLGlCQUtJLE9BSEFpRSxLQUFLekIsVUFBVTBCLFFBQVE0QixNQUFNQyxNQUFPQyxFQUFFdkcsS0FDbEN1RyxFQUFFSyxZQUFZLENBQUVoQyxLQUFNLFdBQVlpQyxHQUFHN0csRUFBRzBHLFNBQVVsQyxLQUFLWSxLQUFNN0UsS0FBTWlFLEtBQUtqRSxLQUFNMEQsS0FBTU8sS0FBS1AsU0FFdEZPLEtBQUt6QixVQUFVc0UsS0FBSzdDLEtBQUtZLE1BSXBDLGdCQUtJLE9BSEFaLEtBQUt6QixVQUFVMEIsUUFBUTRCLE1BQU1DLE1BQU9DLEVBQUV2RyxLQUNsQ3VHLEVBQUVLLFlBQVksQ0FBRWhDLEtBQU0sVUFBV2lDLEdBQUc3RyxFQUFHMEcsU0FBVWxDLEtBQUtZLEtBQU03RSxLQUFNaUUsS0FBS2pFLEtBQU0wRCxLQUFNTyxLQUFLUCxTQUVyRk8sS0FBS3pCLFVBQVVzRSxLQUFLN0MsS0FBS1ksTUFJcEMsU0FBVyxPQUFPWixLQUFLWSxNQUdaLFdBQ1gsS0FBVSxTQUFZLEVBQ3RCLFVBQWUsTUFBQ3JGLEVBQVF1RSxFQUFVLEVBQUVKLEVBQVEsTUFDakMsSUFBSUcsR0FBWWlELFNBQVN2SCxFQUFPdUUsRUFBUUoiLCJmaWxlIjoiZ3JheXNjYWxlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiIFx0Ly8gVGhlIG1vZHVsZSBjYWNoZVxuIFx0dmFyIGluc3RhbGxlZE1vZHVsZXMgPSB7fTtcblxuIFx0Ly8gVGhlIHJlcXVpcmUgZnVuY3Rpb25cbiBcdGZ1bmN0aW9uIF9fd2VicGFja19yZXF1aXJlX18obW9kdWxlSWQpIHtcblxuIFx0XHQvLyBDaGVjayBpZiBtb2R1bGUgaXMgaW4gY2FjaGVcbiBcdFx0aWYoaW5zdGFsbGVkTW9kdWxlc1ttb2R1bGVJZF0pIHtcbiBcdFx0XHRyZXR1cm4gaW5zdGFsbGVkTW9kdWxlc1ttb2R1bGVJZF0uZXhwb3J0cztcbiBcdFx0fVxuIFx0XHQvLyBDcmVhdGUgYSBuZXcgbW9kdWxlIChhbmQgcHV0IGl0IGludG8gdGhlIGNhY2hlKVxuIFx0XHR2YXIgbW9kdWxlID0gaW5zdGFsbGVkTW9kdWxlc1ttb2R1bGVJZF0gPSB7XG4gXHRcdFx0aTogbW9kdWxlSWQsXG4gXHRcdFx0bDogZmFsc2UsXG4gXHRcdFx0ZXhwb3J0czoge31cbiBcdFx0fTtcblxuIFx0XHQvLyBFeGVjdXRlIHRoZSBtb2R1bGUgZnVuY3Rpb25cbiBcdFx0bW9kdWxlc1ttb2R1bGVJZF0uY2FsbChtb2R1bGUuZXhwb3J0cywgbW9kdWxlLCBtb2R1bGUuZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXyk7XG5cbiBcdFx0Ly8gRmxhZyB0aGUgbW9kdWxlIGFzIGxvYWRlZFxuIFx0XHRtb2R1bGUubCA9IHRydWU7XG5cbiBcdFx0Ly8gUmV0dXJuIHRoZSBleHBvcnRzIG9mIHRoZSBtb2R1bGVcbiBcdFx0cmV0dXJuIG1vZHVsZS5leHBvcnRzO1xuIFx0fVxuXG5cbiBcdC8vIGV4cG9zZSB0aGUgbW9kdWxlcyBvYmplY3QgKF9fd2VicGFja19tb2R1bGVzX18pXG4gXHRfX3dlYnBhY2tfcmVxdWlyZV9fLm0gPSBtb2R1bGVzO1xuXG4gXHQvLyBleHBvc2UgdGhlIG1vZHVsZSBjYWNoZVxuIFx0X193ZWJwYWNrX3JlcXVpcmVfXy5jID0gaW5zdGFsbGVkTW9kdWxlcztcblxuIFx0Ly8gZGVmaW5lIGdldHRlciBmdW5jdGlvbiBmb3IgaGFybW9ueSBleHBvcnRzXG4gXHRfX3dlYnBhY2tfcmVxdWlyZV9fLmQgPSBmdW5jdGlvbihleHBvcnRzLCBuYW1lLCBnZXR0ZXIpIHtcbiBcdFx0aWYoIV9fd2VicGFja19yZXF1aXJlX18ubyhleHBvcnRzLCBuYW1lKSkge1xuIFx0XHRcdE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBuYW1lLCB7IGVudW1lcmFibGU6IHRydWUsIGdldDogZ2V0dGVyIH0pO1xuIFx0XHR9XG4gXHR9O1xuXG4gXHQvLyBkZWZpbmUgX19lc01vZHVsZSBvbiBleHBvcnRzXG4gXHRfX3dlYnBhY2tfcmVxdWlyZV9fLnIgPSBmdW5jdGlvbihleHBvcnRzKSB7XG4gXHRcdGlmKHR5cGVvZiBTeW1ib2wgIT09ICd1bmRlZmluZWQnICYmIFN5bWJvbC50b1N0cmluZ1RhZykge1xuIFx0XHRcdE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBTeW1ib2wudG9TdHJpbmdUYWcsIHsgdmFsdWU6ICdNb2R1bGUnIH0pO1xuIFx0XHR9XG4gXHRcdE9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAnX19lc01vZHVsZScsIHsgdmFsdWU6IHRydWUgfSk7XG4gXHR9O1xuXG4gXHQvLyBjcmVhdGUgYSBmYWtlIG5hbWVzcGFjZSBvYmplY3RcbiBcdC8vIG1vZGUgJiAxOiB2YWx1ZSBpcyBhIG1vZHVsZSBpZCwgcmVxdWlyZSBpdFxuIFx0Ly8gbW9kZSAmIDI6IG1lcmdlIGFsbCBwcm9wZXJ0aWVzIG9mIHZhbHVlIGludG8gdGhlIG5zXG4gXHQvLyBtb2RlICYgNDogcmV0dXJuIHZhbHVlIHdoZW4gYWxyZWFkeSBucyBvYmplY3RcbiBcdC8vIG1vZGUgJiA4fDE6IGJlaGF2ZSBsaWtlIHJlcXVpcmVcbiBcdF9fd2VicGFja19yZXF1aXJlX18udCA9IGZ1bmN0aW9uKHZhbHVlLCBtb2RlKSB7XG4gXHRcdGlmKG1vZGUgJiAxKSB2YWx1ZSA9IF9fd2VicGFja19yZXF1aXJlX18odmFsdWUpO1xuIFx0XHRpZihtb2RlICYgOCkgcmV0dXJuIHZhbHVlO1xuIFx0XHRpZigobW9kZSAmIDQpICYmIHR5cGVvZiB2YWx1ZSA9PT0gJ29iamVjdCcgJiYgdmFsdWUgJiYgdmFsdWUuX19lc01vZHVsZSkgcmV0dXJuIHZhbHVlO1xuIFx0XHR2YXIgbnMgPSBPYmplY3QuY3JlYXRlKG51bGwpO1xuIFx0XHRfX3dlYnBhY2tfcmVxdWlyZV9fLnIobnMpO1xuIFx0XHRPYmplY3QuZGVmaW5lUHJvcGVydHkobnMsICdkZWZhdWx0JywgeyBlbnVtZXJhYmxlOiB0cnVlLCB2YWx1ZTogdmFsdWUgfSk7XG4gXHRcdGlmKG1vZGUgJiAyICYmIHR5cGVvZiB2YWx1ZSAhPSAnc3RyaW5nJykgZm9yKHZhciBrZXkgaW4gdmFsdWUpIF9fd2VicGFja19yZXF1aXJlX18uZChucywga2V5LCBmdW5jdGlvbihrZXkpIHsgcmV0dXJuIHZhbHVlW2tleV07IH0uYmluZChudWxsLCBrZXkpKTtcbiBcdFx0cmV0dXJuIG5zO1xuIFx0fTtcblxuIFx0Ly8gZ2V0RGVmYXVsdEV4cG9ydCBmdW5jdGlvbiBmb3IgY29tcGF0aWJpbGl0eSB3aXRoIG5vbi1oYXJtb255IG1vZHVsZXNcbiBcdF9fd2VicGFja19yZXF1aXJlX18ubiA9IGZ1bmN0aW9uKG1vZHVsZSkge1xuIFx0XHR2YXIgZ2V0dGVyID0gbW9kdWxlICYmIG1vZHVsZS5fX2VzTW9kdWxlID9cbiBcdFx0XHRmdW5jdGlvbiBnZXREZWZhdWx0KCkgeyByZXR1cm4gbW9kdWxlWydkZWZhdWx0J107IH0gOlxuIFx0XHRcdGZ1bmN0aW9uIGdldE1vZHVsZUV4cG9ydHMoKSB7IHJldHVybiBtb2R1bGU7IH07XG4gXHRcdF9fd2VicGFja19yZXF1aXJlX18uZChnZXR0ZXIsICdhJywgZ2V0dGVyKTtcbiBcdFx0cmV0dXJuIGdldHRlcjtcbiBcdH07XG5cbiBcdC8vIE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbFxuIFx0X193ZWJwYWNrX3JlcXVpcmVfXy5vID0gZnVuY3Rpb24ob2JqZWN0LCBwcm9wZXJ0eSkgeyByZXR1cm4gT2JqZWN0LnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eS5jYWxsKG9iamVjdCwgcHJvcGVydHkpOyB9O1xuXG4gXHQvLyBfX3dlYnBhY2tfcHVibGljX3BhdGhfX1xuIFx0X193ZWJwYWNrX3JlcXVpcmVfXy5wID0gXCJcIjtcblxuXG4gXHQvLyBMb2FkIGVudHJ5IG1vZHVsZSBhbmQgcmV0dXJuIGV4cG9ydHNcbiBcdHJldHVybiBfX3dlYnBhY2tfcmVxdWlyZV9fKF9fd2VicGFja19yZXF1aXJlX18ucyA9IDIpO1xuIiwiLy8vIDxyZWZlcmVuY2UgcGF0aD1cIi4uL2J1aWxkL2xpYi9jb21wdXRlLmQudHNcIiAvPlxyXG5cclxuaW1wb3J0IHsgQ29tcHV0ZSB9IGZyb20gXCIuLi9idWlsZC9saWIvY29tcHV0ZS5qc1wiO1xyXG5cclxuKGFzeW5jICgpPT57XHJcbiAgICBsZXQgY2FudmFzOiBIVE1MQ2FudmFzRWxlbWVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXCIjY2FudmFzXCIpO1xyXG4gICAgbGV0IGN0eCA9IGNhbnZhcy5nZXRDb250ZXh0KFwiMmRcIik7XHJcblxyXG4gICAgLy8gbG9hZCBpbWFnZSAoc2ltcGxlcilcclxuICAgIGxldCBpbWFnZSA9IG5ldyBJbWFnZSgpO1xyXG4gICAgbGV0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSxyZWplY3QpPT57XHJcbiAgICAgICAgaW1hZ2Uub25sb2FkPXJlc29sdmU7XHJcbiAgICAgICAgaW1hZ2Uub25lcnJvcj1yZWplY3Q7XHJcbiAgICB9KTtcclxuICAgIGltYWdlLnNyYyA9IFwiYXNzZXRzL2ltYWdlcy90ZXN0LnBuZ1wiO1xyXG4gICAgYXdhaXQgcHJvbWlzZTtcclxuXHJcbiAgICAvLyBpbXBvcnQgY29tcHV0ZSBsaWJyYXJ5IFxyXG4gICAgbGV0IGNvbXB1dGU6IENvbXB1dGUuTW9kdWxlID0gKGF3YWl0IGltcG9ydChcIi4vYnVpbGQvbGliL2NvbXB1dGUuanNcIikpLmRlZmF1bHQ7IC8vIFJlcXVpcmVkIFR5cGUgQ29udmVyc2lvblxyXG4gICAgXHJcbiAgICAvLyBjcmVhdGUgd2FzbSB3b3JrZ3JvdXAgKDQgdGhyZWFkcykgd2l0aCBtb2R1bGVcclxuICAgIGxldCB3b3JrZ3JvdXAgPSBhd2FpdCBjb21wdXRlLndvcmtncm91cChcIi4vYnVpbGQvYXNzZW1ibHkvb3B0aW1pemVkLndhc21cIiwgNiwgYFxyXG4gICAgICAgIGF3YWl0IChhc3luYyAoZGF0YSk9PntcclxuICAgICAgICAgICAgcmV0dXJuIGluc3RhbmNlLmV4cG9ydHNbZGF0YS5uYW1lXShpZCwgLi4uZGF0YS5hcmdzKTtcclxuICAgICAgICB9KWApO1xyXG4gICAgY29uc29sZS5sb2coXCJjcmVhdGVkIHdvcmtlcnMhXCIpO1xyXG5cclxuICAgIC8vIFxyXG4gICAgY3R4LmRyYXdJbWFnZShpbWFnZSwwLDApO1xyXG5cclxuICAgIC8vXHJcbiAgICBsZXQgaW1hZ2VEYXRhID0gY3R4LmdldEltYWdlRGF0YSgwLDAsNjQwLDQ4MCk7XHJcbiAgICBsZXQgc2l6ZSA9IE1hdGgubWluKGltYWdlRGF0YS53aWR0aCppbWFnZURhdGEuaGVpZ2h0KjQsMTAyNCoxMDI0KjEwMjQpO1xyXG5cclxuICAgIC8vIGFsbG9jYXRlIHNoYXJlZCBtZW1vcnkgZm9yIHdvcmtcclxuICAgIGxldCBidWZmZXIgPSB3b3JrZ3JvdXAuYWxsb2NhdGUoc2l6ZSk7IC8vIGp1c3QgbnVtYmVyIHBvaW50ZXJcclxuXHJcbiAgICAvLyBtYWtlIHR5cGVkIGFycmF5IGFuZCBzZXQgd2l0aCBpbWFnZSBkYXRhIFxyXG4gICAgbGV0IG1hcCA9IHdvcmtncm91cC5tYXA8VWludDhBcnJheT4oYnVmZmVyLHNpemUsVWludDhBcnJheSk7XHJcbiAgICBtYXAuc2V0KGltYWdlRGF0YS5kYXRhKTsgLy8gc2V0IGJ5IG1hcHBlZCByYW5nZVxyXG4gICAgY29uc29sZS5sb2coXCJhbGxvY2F0aW9uIG9mIHNoYXJlZCBtZW1vcnkgY29tcGxldGUhXCIpO1xyXG5cclxuICAgIC8vIFJ1biBcInN1cHBvcnRcIiB0YXNrIChjYW4gcnVuIFwibWFpblwiIHdpdGhvdXQgaW5wdXQgZGF0YSlcclxuICAgIGF3YWl0IHdvcmtncm91cC50YXNrKHtuYW1lOiBcIm1haW5cIiwgYXJnczogW2ltYWdlRGF0YS53aWR0aCwgaW1hZ2VEYXRhLmhlaWdodCwgYnVmZmVyXX0pLnN1cHBvcnQoKTtcclxuICAgIGNvbnNvbGUubG9nKFwiY29tcHV0ZSBkb25lIVwiKTtcclxuXHJcbiAgICAvLyBzZXQgaW1hZ2VEYXRhIGJ5IG1hcHBlZCBtZW1vcnlcclxuICAgIGltYWdlRGF0YS5kYXRhLnNldChtYXApO1xyXG4gICAgY29uc29sZS5sb2coYGNvcGllZCBiYWNrIGRhdGEgd2l0aCAke3NpemV9IGJ5dGVzIWApO1xyXG5cclxuICAgIC8vIHB1dCBpbWFnZURhdGFcclxuICAgIGN0eC5wdXRJbWFnZURhdGEoaW1hZ2VEYXRhLDAsMCk7XHJcbn0pKCk7XHJcbiIsIlxubGV0IFRocmVhZENvZGUgPSAoc3VwcG9ydCA9IGBgKT0+eyByZXR1cm4gYFxubGV0IGluc3RhbmNlID0gbnVsbCwgdGhyZWFkcyA9IDEsIGlkID0gMDtcbi8vbGV0IHRhYmxlID0gbmV3IFdlYkFzc2VtYmx5LlRhYmxlKHtpbml0aWFsOiAxLCBtYXhpbXVtOiA2NTUzNiwgc2hhcmVkOiB0cnVlLCBlbGVtZW50OiBcImFueWZ1bmNcIn0pO1xuXG4vLyB0aHJlYWQgbmF0aXZlIGRpc3BhdGNoZXIgXG5vbm1lc3NhZ2UgPSBhc3luYyAoZSk9PntcbiAgICBsZXQgcmVzdWx0ID0gbnVsbDtcbiAgICBcbiAgICBpZiAoZS5kYXRhLnR5cGUgPT0gXCJpbml0XCIpIHtcbiAgICAgICAgdGhyZWFkcyA9IGUuZGF0YS50aHJlYWRzLCBpZCA9IGUuZGF0YS5pZDtcblxuICAgICAgICBpbnN0YW5jZSA9IGF3YWl0IFdlYkFzc2VtYmx5Lmluc3RhbnRpYXRlKGUuZGF0YS5tb2R1bGUsIHsgZW52OiB7XG4gICAgICAgICAgICBhYm9ydDogZnVuY3Rpb24oKSB7IHRocm93IEVycm9yKFwiYWJvcnQgY2FsbGVkXCIpOyB9LCBtZW1vcnk6IGUuZGF0YS5tZW1vcnlcbiAgICAgICAgfX0pO1xuXG4gICAgICAgIHJlc3VsdCA9IGF3YWl0IGluc3RhbmNlLmV4cG9ydHMuaW5pdCh0aHJlYWRzKTtcbiAgICB9XG4gICAgXG4gICAgaWYgKGUuZGF0YS50eXBlID09IFwiZGlzcGF0Y2hcIikge1xuICAgICAgICByZXN1bHQgPSBhd2FpdCBpbnN0YW5jZS5leHBvcnRzW2UuZGF0YS5uYW1lXShpZCwgLi4uZS5kYXRhLmFyZ3MpO1xuICAgIH1cbiAgICBcbiAgICBpZiAoZS5kYXRhLnR5cGUgPT0gXCJzdXBwb3J0XCIpIHtcbiAgICAgICAgcmVzdWx0ID0gJHtzdXBwb3J0fShlLmRhdGEpO1xuICAgIH1cblxuICAgIHBvc3RNZXNzYWdlKE9iamVjdC5hc3NpZ24oZS5kYXRhLCB7cmVzdWx0fSkpO1xufVxuYH07XG5cbmNsYXNzIFdvcmtncm91cCB7XG4gICAgY29uc3RydWN0b3IoKXtcbiAgICAgICAgXG4gICAgfVxuICAgIFxuICAgIGFzeW5jIGluaXRpYXRlKG1vZHVsZSwgdGhyZWFkcyA9IDEsIHN1cHBvcnRDb2RlID0gYGApe1xuICAgICAgICAvL1dlYkFzc2VtYmx5Lmluc3RhbnRpYXRlU3RyZWFtaW5nKGZldGNoKFxuICAgICAgICB0aGlzLndvcmtlcnMgPSBbXTtcblxuICAgICAgICAvLyBpbml0aWFsaXplIHRocmVhZHNcbiAgICAgICAgbGV0IGJsb2IgPSBuZXcgQmxvYihbVGhyZWFkQ29kZShzdXBwb3J0Q29kZSldLHt0eXBlOlwidGV4dC9qYXZhc2NyaXB0XCJ9KSwgdXJsID0gVVJMLmNyZWF0ZU9iamVjdFVSTChibG9iKTtcbiAgICAgICAgZm9yIChsZXQgaT0wO2k8dGhyZWFkcztpKyspIHsgdGhpcy53b3JrZXJzLnB1c2gobmV3IFdvcmtlcih1cmwpKTsgfVxuXG4gICAgICAgIC8vIFxuICAgICAgICB0aGlzLnJlcG9uc2VJbmRleCA9IDAsIHRoaXMucmVzcG9uc2VzID0ge307XG5cbiAgICAgICAgLy8gXG4gICAgICAgIGxldCByZXNwID0gdGhpcy5yZXBvbnNlSW5kZXgrKztcbiAgICAgICAgdGhpcy5yZXNwb25zZXNbcmVzcF0gPSBbXTtcblxuICAgICAgICAvLyBpbml0aWFsaXplIHdvcmtlcnNcbiAgICAgICAgdGhpcy5tb2R1bGVGZXRjaCA9IChhd2FpdCBmZXRjaChtb2R1bGUpKS5hcnJheUJ1ZmZlcigpO1xuICAgICAgICB0aGlzLm1vZHVsZSA9IGF3YWl0IFdlYkFzc2VtYmx5LmNvbXBpbGUoYXdhaXQgdGhpcy5tb2R1bGVGZXRjaCk7XG5cbiAgICAgICAgLy8gY3JlYXRlIHNoYXJlZCBtZW1vcnkgbW9kZWxcbiAgICAgICAgdGhpcy5tZW1vcnkgPSBuZXcgV2ViQXNzZW1ibHkuTWVtb3J5KHtpbml0aWFsOiAxLCBtYXhpbXVtOiA2NTUzNiwgc2hhcmVkOiB0cnVlfSk7XG4gICAgICAgIC8vdGhpcy50YWJsZSA9IG5ldyBXZWJBc3NlbWJseS5UYWJsZSh7aW5pdGlhbDogMSwgbWF4aW11bTogNjU1MzYsIHNoYXJlZDogdHJ1ZSwgZWxlbWVudDogXCJhbnlmdW5jXCJ9KTtcblxuICAgICAgICAvLyBjcmVhdGUgaG9zdC9tYW5hZ2VyIGluc3RhbmNlXG4gICAgICAgIHRoaXMuaW5zdGFuY2UgPSBhd2FpdCBXZWJBc3NlbWJseS5pbnN0YW50aWF0ZSh0aGlzLm1vZHVsZSwgeyBlbnY6IHtcbiAgICAgICAgICAgIG1lbW9yeTogdGhpcy5tZW1vcnksXG4gICAgICAgICAgICBhYm9ydDogZnVuY3Rpb24oKSB7IHRocm93IEVycm9yKFwiYWJvcnQgY2FsbGVkXCIpOyB9XG4gICAgICAgIH19KTtcbiAgICAgICAgdGhpcy5pbnN0YW5jZS5leHBvcnRzLmluaXQodGhyZWFkcyk7XG5cbiAgICAgICAgdGhpcy53b3JrZXJzLmV2ZXJ5KGFzeW5jICh3LGkpPT57XG4gICAgICAgICAgICB3LnJlc3BvbnNlcyA9IHt9O1xuICAgICAgICAgICAgdy5vbm1lc3NhZ2UgPSAoZSk9Pnsgdy5yZXNwb25zZXNbZS5kYXRhLnJlc3BvbnNlXS5yZXNvbHZlZCA9IGUuZGF0YTsgfTtcblxuICAgICAgICAgICAgLy8gYWRkIG5ldyB0YXNrIGludG8gd29ya2VyXG4gICAgICAgICAgICBsZXQgcmVzcG9uc2UgPSB7fTsgdy5yZXNwb25zZXNbcmVzcF0gPSByZXNwb25zZTsgLy8gaW5pdGlhbGl6ZSByZXNvbHZlclxuICAgICAgICAgICAgdGhpcy5yZXNwb25zZXNbcmVzcF1baV0gPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSxyZWplY3QpPT57IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShyZXNwb25zZSwgXCJyZXNvbHZlZFwiLCB7c2V0OiB2YWx1ZSA9PiB7IHZhbHVlP3Jlc29sdmUodmFsdWUpOnJlamVjdCgpOyB9fSk7IH0pO1xuXG4gICAgICAgICAgICAvLyBzZW5kIGNvbW1hbmQgaW50byB3b3JrZXJcbiAgICAgICAgICAgIHcucG9zdE1lc3NhZ2UoeyByZXNwb25zZTogcmVzcCwgdHlwZTogXCJpbml0XCIsIG1vZHVsZTogdGhpcy5tb2R1bGUsIG1lbW9yeTogdGhpcy5tZW1vcnksIHRocmVhZHMsIGlkOiBpIH0pO1xuICAgICAgICB9KTtcblxuICAgICAgICAvLyBhd2FpdCBpbml0aWFsaXphdGlvbiBvZiB3b3JrZXJzXG4gICAgICAgIGF3YWl0IFByb21pc2UuYWxsKHRoaXMucmVzcG9uc2VzW3Jlc3BdKTtcblxuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvLyB3YWl0IHRhc2sgYnkgSURcbiAgICBhc3luYyB3YWl0KHJlc3Ape1xuICAgICAgICBsZXQgcmVzdWx0ID0gYXdhaXQgUHJvbWlzZS5hbGwodGhpcy5yZXNwb25zZXNbcmVzcF0pO1xuICAgICAgICBkZWxldGUgdGhpcy5yZXNwb25zZXNbcmVzcF07XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuICAgIFxuICAgIC8vIGNyZWF0ZSB3b3JrIHRhc2sgXG4gICAgdGFzayh7bmFtZT1cIm1haW5cIixhcmdzPVtdfSl7XG4gICAgICAgIC8vIFxuICAgICAgICBsZXQgcmVzcCA9IHRoaXMucmVwb25zZUluZGV4Kys7XG4gICAgICAgIHRoaXMucmVzcG9uc2VzW3Jlc3BdID0gW107XG4gICAgICAgIFxuICAgICAgICAvLyBhZGQgbmV3IHRhc2sgaW50byB3b3JrZXJcbiAgICAgICAgdGhpcy53b3JrZXJzLmV2ZXJ5KGFzeW5jICh3LGkpPT57XG4gICAgICAgICAgICBsZXQgcmVzcG9uc2UgPSB7fTsgdy5yZXNwb25zZXNbcmVzcF0gPSByZXNwb25zZTsgLy8gaW5pdGlhbGl6ZSByZXNvbHZlclxuICAgICAgICAgICAgdGhpcy5yZXNwb25zZXNbcmVzcF1baV0gPSBuZXcgUHJvbWlzZSgocmVzb2x2ZSxyZWplY3QpPT57IE9iamVjdC5kZWZpbmVQcm9wZXJ0eShyZXNwb25zZSwgXCJyZXNvbHZlZFwiLCB7c2V0OiB2YWx1ZSA9PiB7IHZhbHVlP3Jlc29sdmUodmFsdWUpOnJlamVjdCgpOyB9fSk7IH0pO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gbmV3IFdvcmt0YXNrKHtuYW1lLGFyZ3MscmVzcCx3b3JrZ3JvdXA6dGhpc30pO1xuICAgIH1cbiAgICBcbiAgICAvLyBhbGxvY2F0ZSBtZW1vcnkgZm9yIHdvcmtcbiAgICBhbGxvY2F0ZShzaXplID0gNCl7XG4gICAgICAgIHJldHVybiB0aGlzLmluc3RhbmNlLmV4cG9ydHMuYWxsb2NhdGUoc2l6ZSk7XG4gICAgfVxuXG4gICAgLy8gZnJlZSBtZW1vcnkgcG9pbnRlclxuICAgIGZyZWUocG9pbnRlcil7XG4gICAgICAgIHJldHVybiB0aGlzLmluc3RhbmNlLmV4cG9ydHMuZnJlZShwb2ludGVyKTtcbiAgICB9XG5cbiAgICAvLyBnZXQgd29ya2dyb3VwIG1lbW9yeSBvYmplY3QgXG4gICAgbWFwKHB0ciwgcmFuZ2UgPSAwLCB0eXBlID0gVWludDhBcnJheSl7XG4gICAgICAgIGlmIChyYW5nZSkge1xuICAgICAgICAgICAgcmV0dXJuIG5ldyB0eXBlKHRoaXMuaW5zdGFuY2UuZXhwb3J0cy5tZW1vcnkuYnVmZmVyLCBwdHIsIHJhbmdlKTsgLy8gUmFuZ2VkXG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IHR5cGUodGhpcy5pbnN0YW5jZS5leHBvcnRzLm1lbW9yeS5idWZmZXIsIHB0cik7IC8vIFdob2xlIFNpemUgKG1heSB1c2VkIGZvciBXZWJHUFUpXG4gICAgICAgIH1cbiAgICB9XG59XG5cbmNsYXNzIFdvcmt0YXNrIHtcbiAgICBjb25zdHJ1Y3Rvcih7bmFtZT1cIm1haW5cIixhcmdzPVtdLHJlc3A9MCx3b3JrZ3JvdXB9KSB7XG4gICAgICAgIHRoaXMud29ya2dyb3VwID0gd29ya2dyb3VwLCB0aGlzLnJlc3AgPSByZXNwLCB0aGlzLmFyZ3MgPSBhcmdzLCB0aGlzLm5hbWUgPSBuYW1lO1xuICAgIH1cblxuICAgIC8vIHNlbmQgY29tbWFuZCBmb3IgY29tcHV0aW5nXG4gICAgYXN5bmMgZGlzcGF0Y2goKSB7XG4gICAgICAgIC8vL3JldHVybiB0aGlzLndvcmtncm91cC5pbnN0YW5jZS5leHBvcnRzW3RoaXMubmFtZV0oMCwgLi4udGhpcy5hcmdzKTtcbiAgICAgICAgdGhpcy53b3JrZ3JvdXAud29ya2Vycy5ldmVyeShhc3luYyAodyxpKT0+e1xuICAgICAgICAgICAgdy5wb3N0TWVzc2FnZSh7IHR5cGU6IFwiZGlzcGF0Y2hcIiwgaWQ6aSwgcmVzcG9uc2U6IHRoaXMucmVzcCwgbmFtZTogdGhpcy5uYW1lLCBhcmdzOiB0aGlzLmFyZ3MgfSk7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gdGhpcy53b3JrZ3JvdXAud2FpdCh0aGlzLnJlc3ApO1xuICAgIH1cblxuICAgIC8vIHNlbmQgY29tbWFuZCBmb3IgamF2YXNjcmlwdCBob3N0IG1hbmFnZXJcbiAgICBhc3luYyBzdXBwb3J0KCkge1xuICAgICAgICAvLy9yZXR1cm4gdGhpcy53b3JrZ3JvdXAuaW5zdGFuY2UuZXhwb3J0c1t0aGlzLm5hbWVdKDAsIC4uLnRoaXMuYXJncyk7XG4gICAgICAgIHRoaXMud29ya2dyb3VwLndvcmtlcnMuZXZlcnkoYXN5bmMgKHcsaSk9PntcbiAgICAgICAgICAgIHcucG9zdE1lc3NhZ2UoeyB0eXBlOiBcInN1cHBvcnRcIiwgaWQ6aSwgcmVzcG9uc2U6IHRoaXMucmVzcCwgbmFtZTogdGhpcy5uYW1lLCBhcmdzOiB0aGlzLmFyZ3MgfSk7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gdGhpcy53b3JrZ3JvdXAud2FpdCh0aGlzLnJlc3ApO1xuICAgIH1cblxuICAgIC8vIGdldCB0YXNrIElEIChub3QgcmVjb21tZW5kZWQpXG4gICAgZ2V0IGlkKCkgeyByZXR1cm4gdGhpcy5yZXNwOyB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IHtcbiAgICBhc3luYyBpbml0KCkgeyByZXR1cm4gMDsgfSxcbiAgICBhc3luYyB3b3JrZ3JvdXAobW9kdWxlLCB0aHJlYWRzID0gMSxzdXBwb3J0PWBgKSB7XG4gICAgICAgIHJldHVybiBuZXcgV29ya2dyb3VwKCkuaW5pdGlhdGUobW9kdWxlLHRocmVhZHMsc3VwcG9ydCk7XG4gICAgfVxufTtcbiJdLCJzb3VyY2VSb290IjoiIn0=